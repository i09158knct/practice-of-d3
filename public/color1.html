<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>D3</title>
  <link rel="stylesheet" href="css/main.css">
  <script src="js/vendor/d3.js"></script>
  <script src="js/vendor/jquery.js"></script>
  <script src="js/vendor/underscore.js"></script>
  <script src="js/vendor/underscore.string.js"></script>
  <script src="js/vendor/backbone.js"></script>
  <script src="js/vendor/coffee-script.js"></script>
  <script>
    window._s = _.string;
  </script>
</head>
<body>
<div class="main" id="main">
  <svg class="map"></svg>
</div>
<script>
var width = 700;
var height = 470;

var projection = d3.geo.mercator()
  .scale(40000)
  .translate([width / 2, height / 2]);

projection.center([133.947083, 34.288472]);

var path = d3.geo.path().projection(projection);

var svg = d3.select('#main .map')
  .attr('width', width)
  .attr('height', height);

svg.append('rect')
  .attr('class', 'background')
  .attr('width', width)
  .attr('height', height)

var areas = svg.append('g')
  .attr('id', 'areas')

d3.json('../data/city/kagawa.json', function(err, areasJSON) {
  window.cityTable = buildCityTable(areasJSON);

  d3.json('../data/geo/kagawa0.001.json', function(err, json) {
    areas.selectAll('path')
      .data(json.features)
      .enter()
      .append('path')
        .attr('d', path)
        .attr('class', function(d) {
          return cityTable[getCityName(d)]['romaji'];
        });

    colorize(cityTable);
  });

});

function buildCityTable(areasJSON) {
  return areasJSON.reduce(function(acc, city) {
    acc[city['city_name']] = city;
    return acc;
  }, {});
}

function getCityName(datum) {
  return datum.properties['N03_004'];
}

function colorize(cityTable) {
  var i = 0;
  var colors = d3.scale.category20().range();
  _.each(cityTable, function(details) {
    d3.selectAll('.' + details['romaji'])
      .style('fill', colors[i++]);
  });
}

</script>
</body>
</html>
